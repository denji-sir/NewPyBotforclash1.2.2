# –°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–≥—Ä–æ–∫–æ–≤ NewPyBot v1.2.2

## üìã –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞** - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ Clash of Clans API –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã —Å–∏—Å—Ç–µ–º—ã:**
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üìä **–¢–æ—á–Ω–æ—Å—Ç—å** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ API –¥–∞–Ω–Ω—ã–µ
- üìà **–ò—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—å** - –≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- üéØ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Ç–µ—Å–Ω–∞—è —Å–≤—è–∑—å —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–∞—Å–ø–æ—Ä—Ç–æ–≤ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### üè∞ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

#### –ö—É–±–∫–∏ –∏ –ª–∏–≥–∏
```
–¢—Ä–æ—Ñ–µ–∏:
- current_trophies: –¢–µ–∫—É—â–∏–µ –∫—É–±–∫–∏
- best_trophies: –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- daily_trophy_change: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
- weekly_trophy_trend: –¢—Ä–µ–Ω–¥ –∑–∞ –Ω–µ–¥–µ–ª—é
- league_id: ID —Ç–µ–∫—É—â–µ–π –ª–∏–≥–∏
- league_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–≥–∏

Builder Base:
- bb_trophies: –ö—É–±–∫–∏ Builder Base
- bb_best_trophies: –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç BB
- bb_wins: –ü–æ–±–µ–¥ –ø—Ä–æ—Ç–∏–≤ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
```

#### –£—Ä–æ–≤–Ω–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ
```
–ü—Ä–æ–≥—Ä–µ—Å—Å:
- exp_level: –£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞
- exp_points: –û—á–∫–∏ –æ–ø—ã—Ç–∞
- town_hall_level: –£—Ä–æ–≤–µ–Ω—å Town Hall
- town_hall_weapon_level: –£—Ä–æ–≤–µ–Ω—å –æ—Ä—É–∂–∏—è –¢–•
- builder_hall_level: –£—Ä–æ–≤–µ–Ω—å Builder Hall

–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
- achievement_points: –û—á–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
- completed_achievements: –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∞—á–∏–≤–∫–∏
- achievement_progress: JSON —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
```

#### –í–æ–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å  
```
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ç–∞–∫:
- attack_wins: –ü–æ–±–µ–¥—ã –≤ –∞—Ç–∞–∫–∞—Ö
- defense_wins: –£—Å–ø–µ—à–Ω—ã–µ –∑–∞—â–∏—Ç—ã
- total_stars: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥
- war_stars: –ó–≤–µ–∑–¥—ã –≤ –≤–æ–π–Ω–∞—Ö –∫–ª–∞–Ω–∞
- capital_contributions: –í–∫–ª–∞–¥ –≤ Capital Raids

–î–æ–Ω–∞—Ç—ã:
- donations_given: –í–æ–π—Å–∫–∞ –æ—Ç–¥–∞–Ω—ã
- donations_received: –í–æ–π—Å–∫–∞ –ø–æ–ª—É—á–µ–Ω—ã  
- donation_ratio: –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–æ–Ω–∞—Ç–æ–≤
```

### üéÅ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

#### –†–µ—Å—É—Ä—Å—ã (—á–µ—Ä–µ–∑ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
```
Gold:
- gold_grab_achievement: –ü—Ä–æ–≥—Ä–µ—Å—Å "Gold Grab"
- daily_gold_farmed: –†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ –¥–µ–Ω—å
- total_gold_farmed: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ñ–∞—Ä–º–ª–µ–Ω–Ω–æ–≥–æ

Elixir:  
- elixir_escapade_achievement: –ü—Ä–æ–≥—Ä–µ—Å—Å "Elixir Escapade"  
- daily_elixir_farmed: –†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ –¥–µ–Ω—å
- total_elixir_farmed: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

Dark Elixir:
- heroic_heist_achievement: –ü—Ä–æ–≥—Ä–µ—Å—Å "Heroic Heist"
- daily_dark_elixir_farmed: –†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ –¥–µ–Ω—å
- total_dark_elixir_farmed: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

Capital Gold:
- aggressive_capitalism: –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
- daily_capital_gold: –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å
- raid_medal_rewards: –ú–µ–¥–∞–ª–∏ –æ—Ç —Ä–µ–π–¥–æ–≤
```

#### –ë–æ–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (—Ñ–∞—Ä–º —á–µ—Ä–µ–∑ –∞—Ç–∞–∫–∏)
```
–†–∞–∑—Ä—É—à–µ–Ω–∏—è:
- destructor_achievement: –ü—Ä–æ–≥—Ä–µ—Å—Å "Destructor" 
- buildings_destroyed: –ó–¥–∞–Ω–∏—è —Ä–∞–∑—Ä—É—à–µ–Ω–æ
- daily_destruction: –†–∞–∑—Ä—É—à–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å

Obstacles:
- nice_and_tidy: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
- obstacles_removed: –£–±—Ä–∞–Ω–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
- gem_rewards: –ì–µ–º—ã –∑–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
```

### üìä –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏ –∫–ª–∞–Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

#### –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∫–ª–∞–Ω–µ
```
–£—á–∞—Å—Ç–∏–µ:
- clan_role: –†–æ–ª—å –≤ –∫–ª–∞–Ω–µ
- clan_join_date: –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- time_in_clan: –í—Ä–µ–º—è –≤ —Ç–µ–∫—É—â–µ–º –∫–ª–∞–Ω–µ
- previous_clans: –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∞–Ω–æ–≤

–í–æ–π–Ω—ã:
- war_participation: –£—á–∞—Å—Ç–∏–µ –≤ –≤–æ–π–Ω–∞—Ö
- war_performance: –ö–∞—á–µ—Å—Ç–≤–æ –∞—Ç–∞–∫ –≤ –≤–æ–π–Ω–∞—Ö
- missed_attacks: –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏
- war_mvp_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ MVP –≤ –≤–æ–π–Ω–∞—Ö

Capital Raids:
- raid_attacks_used: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏
- raid_damage_dealt: –ù–∞–Ω–µ—Å–µ–Ω–Ω—ã–π —É—Ä–æ–Ω
- raid_medals_earned: –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–µ–¥–∞–ª–∏
- raid_consistency: –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å —É—á–∞—Å—Ç–∏—è
```

#### –õ–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ –≤–ª–∏—è–Ω–∏–µ  
```
–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ:
- friend_in_need: –ü–æ–º–æ—â—å —Å–æ–≥–∏–ª—å–¥–∏–π—Ü–∞–º (–¥–æ–Ω–∞—Ç—ã)
- sharing_is_caring: –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –æ—Ç–¥–∞–Ω—ã
- siege_sharer: –û—Å–∞–¥–Ω—ã–µ –º–∞—à–∏–Ω—ã –ø–µ—Ä–µ–¥–∞–Ω—ã

–ö–∞—á–µ—Å—Ç–≤–æ –∏–≥—Ä—ã:
- attack_strategy_diversity: –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- base_design_rating: –û—Ü–µ–Ω–∫–∞ –¥–∏–∑–∞–π–Ω–∞ –±–∞–∑—ã
- helping_new_players: –ü–æ–º–æ—â—å –Ω–æ–≤–∏—á–∫–∞–º –≤ –∫–ª–∞–Ω–µ
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–µ—Ç—Ä–∏–∫

#### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã –∏–≥—Ä–æ–∫–æ–≤
```sql
-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤
CREATE TABLE daily_player_snapshots (
    id SERIAL PRIMARY KEY,
    player_tag VARCHAR(15) NOT NULL,
    snapshot_date DATE NOT NULL,
    
    -- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    trophies INTEGER NOT NULL,
    best_trophies INTEGER NOT NULL,
    exp_level INTEGER NOT NULL,
    exp_points INTEGER NOT NULL,
    town_hall_level INTEGER NOT NULL,
    town_hall_weapon_level INTEGER DEFAULT NULL,
    builder_hall_level INTEGER DEFAULT NULL,
    
    -- Builder Base
    bb_trophies INTEGER DEFAULT 0,
    bb_best_trophies INTEGER DEFAULT 0,
    bb_wins INTEGER DEFAULT 0,
    
    -- –õ–∏–≥–∞
    league_id INTEGER DEFAULT NULL,
    league_name VARCHAR(50) DEFAULT NULL,
    
    -- –ë–æ–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    attack_wins INTEGER DEFAULT 0,
    defense_wins INTEGER DEFAULT 0,
    war_stars INTEGER DEFAULT 0,
    
    -- –î–æ–Ω–∞—Ç—ã
    donations_given INTEGER DEFAULT 0,
    donations_received INTEGER DEFAULT 0,
    
    -- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (JSON –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏)
    achievements_progress JSON NOT NULL DEFAULT '{}',
    
    -- –ö–ª–∞–Ω–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    clan_tag VARCHAR(15) DEFAULT NULL,
    clan_name VARCHAR(100) DEFAULT NULL,
    clan_role VARCHAR(20) DEFAULT NULL,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    api_response_hash VARCHAR(64), -- –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(player_tag, snapshot_date),
    INDEX idx_player_date (player_tag, snapshot_date DESC),
    INDEX idx_snapshot_date (snapshot_date),
    INDEX idx_clan_tag (clan_tag, snapshot_date)
);

-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π  
CREATE TABLE player_daily_changes (
    id SERIAL PRIMARY KEY,
    player_tag VARCHAR(15) NOT NULL,
    change_date DATE NOT NULL,
    
    -- –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫—É–±–∫–æ–≤
    trophy_change INTEGER DEFAULT 0,
    bb_trophy_change INTEGER DEFAULT 0,
    
    -- –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–ø—ã—Ç–∞ –∏ —É—Ä–æ–≤–Ω–µ–π
    exp_gained INTEGER DEFAULT 0,
    level_ups INTEGER DEFAULT 0, -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–Ω—è—Ç—ã—Ö —É—Ä–æ–≤–Ω–µ–π (–¢–•, –ë–• –∏ —Ç.–¥.)
    
    -- –ò–∑–º–µ–Ω–µ–Ω–∏—è –±–æ–µ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    attacks_won INTEGER DEFAULT 0,
    defenses_won INTEGER DEFAULT 0,
    war_stars_gained INTEGER DEFAULT 0,
    
    -- –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–Ω–∞—Ç–æ–≤
    donations_made INTEGER DEFAULT 0,
    donations_got INTEGER DEFAULT 0,
    
    -- –†–µ—Å—É—Ä—Å—ã (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ)
    gold_farmed BIGINT DEFAULT 0,
    elixir_farmed BIGINT DEFAULT 0,
    dark_elixir_farmed INTEGER DEFAULT 0,
    capital_gold_earned INTEGER DEFAULT 0,
    
    -- –î—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    buildings_destroyed INTEGER DEFAULT 0,
    obstacles_removed INTEGER DEFAULT 0,
    achievements_completed INTEGER DEFAULT 0,
    
    -- –ö–ª–∞–Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    clan_changed BOOLEAN DEFAULT FALSE,
    new_clan_tag VARCHAR(15) DEFAULT NULL,
    role_changed BOOLEAN DEFAULT FALSE,
    new_role VARCHAR(20) DEFAULT NULL,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    calculated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(player_tag, change_date),
    INDEX idx_player_changes (player_tag, change_date DESC),
    INDEX idx_change_date (change_date),
    INDEX idx_trophy_change (change_date, trophy_change DESC)
);

-- –¢–∞–±–ª–∏—Ü–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥—ã
CREATE TABLE player_period_stats (
    id SERIAL PRIMARY KEY,
    player_tag VARCHAR(15) NOT NULL,
    period_type VARCHAR(10) NOT NULL, -- 'week', 'month', 'season'
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    
    -- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    total_trophy_change INTEGER DEFAULT 0,
    total_gold_farmed BIGINT DEFAULT 0,
    total_elixir_farmed BIGINT DEFAULT 0,
    total_dark_elixir_farmed INTEGER DEFAULT 0,
    total_capital_gold BIGINT DEFAULT 0,
    
    total_attacks_won INTEGER DEFAULT 0,
    total_defenses_won INTEGER DEFAULT 0,
    total_war_stars INTEGER DEFAULT 0,
    total_donations_made INTEGER DEFAULT 0,
    
    -- –°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    avg_daily_trophies DECIMAL(8,2) DEFAULT 0,
    avg_daily_donations DECIMAL(8,2) DEFAULT 0,
    
    -- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
    achievements_earned INTEGER DEFAULT 0,
    levels_gained INTEGER DEFAULT 0,
    
    -- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    days_active INTEGER DEFAULT 0, -- –î–Ω–µ–π —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
    consistency_score DECIMAL(5,2) DEFAULT 0, -- –ò–Ω–¥–µ–∫—Å –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–∞
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    calculated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(player_tag, period_type, period_start),
    INDEX idx_player_period (player_tag, period_type, period_start DESC),
    INDEX idx_period_stats (period_type, period_start)
);
```

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏–≥—Ä–æ–∫–æ–≤
```sql  
-- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º Clash of Clans
CREATE TABLE coc_achievement_tracking (
    id SERIAL PRIMARY KEY,
    player_tag VARCHAR(15) NOT NULL,
    achievement_name VARCHAR(100) NOT NULL, -- "Gold Grab", "Elixir Escapade" –∏ —Ç.–¥.
    
    current_value BIGINT DEFAULT 0,      -- –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    target_value BIGINT DEFAULT 0,       -- –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    is_completed BOOLEAN DEFAULT FALSE,  -- –ó–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
    
    -- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    previous_value BIGINT DEFAULT 0,     -- –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    daily_progress BIGINT DEFAULT 0,     -- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å
    
    last_updated DATE DEFAULT CURRENT_DATE,
    completed_at DATE DEFAULT NULL,
    
    UNIQUE(player_tag, achievement_name),
    INDEX idx_player_achievements (player_tag),
    INDEX idx_achievement_progress (achievement_name, current_value DESC)
);

-- –°–≤—è–∑—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π CoC —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞
CREATE TABLE achievement_mapping (
    id SERIAL PRIMARY KEY,
    passport_achievement_id INTEGER NOT NULL, -- ID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã achievements
    coc_achievement_name VARCHAR(100) NOT NULL, -- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ CoC
    calculation_type VARCHAR(20) NOT NULL,   -- 'direct', 'calculated', 'threshold'
    
    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞
    multiplier DECIMAL(10,4) DEFAULT 1.0,   -- –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
    threshold_value BIGINT DEFAULT NULL,     -- –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    
    FOREIGN KEY (passport_achievement_id) REFERENCES achievements(id),
    INDEX idx_coc_achievement (coc_achievement_name),
    INDEX idx_passport_achievement (passport_achievement_id)
);
```

### –°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

#### –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
```python
class PlayerMetricsCollector:
    def __init__(self, coc_api, db_connection):
        self.coc_api = coc_api
        self.db = db_connection
        self.logger = logging.getLogger(__name__)
        
    async def collect_daily_snapshots(self) -> Dict:
        """–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤—Å–µ—Ö –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤"""
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
        bound_players = await self.db.fetch_all("""
            SELECT DISTINCT player_tag FROM user_player_bindings 
            WHERE is_active = TRUE
        """)
        
        results = {
            'success': 0,
            'failed': 0,
            'errors': []
        }
        
        # Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        batch_size = 100
        for i in range(0, len(bound_players), batch_size):
            batch = bound_players[i:i + batch_size]
            
            # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API
            tasks = [
                self._collect_player_snapshot(player['player_tag']) 
                for player in batch
            ]
            
            batch_results = await asyncio.gather(*tasks, return_exceptions=True)
            
            for result in batch_results:
                if isinstance(result, Exception):
                    results['failed'] += 1
                    results['errors'].append(str(result))
                else:
                    results['success'] += 1
                    
        return results
    
    async def _collect_player_snapshot(self, player_tag: str) -> bool:
        """–°–±–æ—Ä —Å–Ω–∞–ø—à–æ—Ç–∞ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞"""
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ API
            player_data = await self.coc_api.get_player(player_tag)
            if not player_data:
                raise ValueError(f"Player not found: {player_tag}")
            
            # –°–æ–∑–¥–∞–µ–º —Ö–µ—à –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            data_hash = self._calculate_data_hash(player_data)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞
            last_hash = await self.db.fetch_val("""
                SELECT api_response_hash FROM daily_player_snapshots
                WHERE player_tag = ? AND snapshot_date = CURRENT_DATE - INTERVAL '1 day'
            """, (player_tag,))
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–Ω–∞–ø—à–æ—Ç
            snapshot_data = self._extract_snapshot_data(player_data)
            snapshot_data['api_response_hash'] = data_hash
            
            await self._save_snapshot(player_tag, snapshot_data)
            
            # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if data_hash != last_hash:
                await self._calculate_daily_changes(player_tag, player_data)
                await self._update_achievement_progress(player_tag, player_data)
            
            return True
            
        except Exception as e:
            self.logger.error(f"Failed to collect snapshot for {player_tag}: {e}")
            raise
    
    def _extract_snapshot_data(self, player_data: Dict) -> Dict:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏–∑ API –æ—Ç–≤–µ—Ç–∞"""
        
        return {
            'trophies': player_data.get('trophies', 0),
            'best_trophies': player_data.get('bestTrophies', 0),
            'exp_level': player_data.get('expLevel', 0),
            'exp_points': player_data.get('expPoints', 0),
            'town_hall_level': player_data.get('townHallLevel', 0),
            'town_hall_weapon_level': player_data.get('townHallWeaponLevel'),
            'builder_hall_level': player_data.get('builderHallLevel', 0),
            
            'bb_trophies': player_data.get('builderBaseTrophies', 0),
            'bb_best_trophies': player_data.get('bestBuilderBaseTrophies', 0),
            'bb_wins': player_data.get('versusBattleWins', 0),
            
            'league_id': player_data.get('league', {}).get('id'),
            'league_name': player_data.get('league', {}).get('name'),
            
            'attack_wins': player_data.get('attackWins', 0),
            'defense_wins': player_data.get('defenseWins', 0),
            'war_stars': player_data.get('warStars', 0),
            
            'donations_given': player_data.get('donations', 0),
            'donations_received': player_data.get('donationsReceived', 0),
            
            'clan_tag': player_data.get('clan', {}).get('tag'),
            'clan_name': player_data.get('clan', {}).get('name'),  
            'clan_role': player_data.get('role'),
            
            'achievements_progress': self._extract_achievements(player_data.get('achievements', []))
        }
    
    def _extract_achievements(self, achievements: List[Dict]) -> Dict:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"""
        
        progress = {}
        
        # –í–∞–∂–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
        key_achievements = {
            'Gold Grab': 'gold_grab',
            'Elixir Escapade': 'elixir_escapade', 
            'Heroic Heist': 'heroic_heist',
            'Aggressive Capitalism': 'aggressive_capitalism',
            'Destructor': 'destructor',
            'Nice and Tidy': 'nice_and_tidy',
            'Friend in Need': 'friend_in_need',
            'Sharing is caring': 'sharing_is_caring'
        }
        
        for achievement in achievements:
            name = achievement.get('name', '')
            if name in key_achievements:
                key = key_achievements[name]
                progress[key] = {
                    'name': name,
                    'value': achievement.get('value', 0),
                    'target': achievement.get('target', 0),
                    'completed': achievement.get('completionInfo', {}).get('time') is not None
                }
                
        return progress
```

#### –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
```python
class MetricsCalculator:
    def __init__(self, db_connection):
        self.db = db_connection
        
    async def calculate_daily_changes(self, player_tag: str) -> Dict:
        """–†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å"""
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–Ω–∞–ø—à–æ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –≤—á–µ—Ä–∞
        today_snapshot = await self._get_snapshot(player_tag, 'CURRENT_DATE')
        yesterday_snapshot = await self._get_snapshot(player_tag, 'CURRENT_DATE - INTERVAL 1 DAY')
        
        if not yesterday_snapshot:
            return {}  # –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            
        changes = {
            'trophy_change': today_snapshot['trophies'] - yesterday_snapshot['trophies'],
            'bb_trophy_change': today_snapshot['bb_trophies'] - yesterday_snapshot['bb_trophies'],
            'exp_gained': today_snapshot['exp_points'] - yesterday_snapshot['exp_points'],
            'attacks_won': today_snapshot['attack_wins'] - yesterday_snapshot['attack_wins'],
            'defenses_won': today_snapshot['defense_wins'] - yesterday_snapshot['defense_wins'],
            'war_stars_gained': today_snapshot['war_stars'] - yesterday_snapshot['war_stars'],
            'donations_made': today_snapshot['donations_given'] - yesterday_snapshot['donations_given'],
            'donations_got': today_snapshot['donations_received'] - yesterday_snapshot['donations_received']
        }
        
        # –†–∞—Å—á–µ—Ç –Ω–∞—Ñ–∞—Ä–º–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        resource_changes = await self._calculate_resource_changes(
            today_snapshot, yesterday_snapshot
        )
        changes.update(resource_changes)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∞–Ω–∞
        clan_changes = self._calculate_clan_changes(today_snapshot, yesterday_snapshot)
        changes.update(clan_changes)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        await self._save_daily_changes(player_tag, changes)
        
        return changes
    
    async def _calculate_resource_changes(self, today: Dict, yesterday: Dict) -> Dict:
        """–†–∞—Å—á–µ—Ç –Ω–∞—Ñ–∞—Ä–º–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è"""
        
        today_achievements = today['achievements_progress']
        yesterday_achievements = yesterday['achievements_progress']
        
        changes = {
            'gold_farmed': 0,
            'elixir_farmed': 0,
            'dark_elixir_farmed': 0,
            'capital_gold_earned': 0,
            'buildings_destroyed': 0,
            'obstacles_removed': 0
        }
        
        # –ó–æ–ª–æ—Ç–æ (Gold Grab achievement)
        if 'gold_grab' in today_achievements and 'gold_grab' in yesterday_achievements:
            changes['gold_farmed'] = (
                today_achievements['gold_grab']['value'] - 
                yesterday_achievements['gold_grab']['value']
            )
            
        # –≠–ª–∏–∫—Å–∏—Ä (Elixir Escapade achievement)  
        if 'elixir_escapade' in today_achievements and 'elixir_escapade' in yesterday_achievements:
            changes['elixir_farmed'] = (
                today_achievements['elixir_escapade']['value'] - 
                yesterday_achievements['elixir_escapade']['value']
            )
            
        # –¢–µ–º–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä (Heroic Heist achievement)
        if 'heroic_heist' in today_achievements and 'heroic_heist' in yesterday_achievements:
            changes['dark_elixir_farmed'] = (
                today_achievements['heroic_heist']['value'] - 
                yesterday_achievements['heroic_heist']['value']
            )
            
        # Capital Gold (Aggressive Capitalism achievement)
        if 'aggressive_capitalism' in today_achievements and 'aggressive_capitalism' in yesterday_achievements:
            changes['capital_gold_earned'] = (
                today_achievements['aggressive_capitalism']['value'] - 
                yesterday_achievements['aggressive_capitalism']['value']
            )
            
        # –†–∞–∑—Ä—É—à–µ–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è (Destructor achievement)
        if 'destructor' in today_achievements and 'destructor' in yesterday_achievements:
            changes['buildings_destroyed'] = (
                today_achievements['destructor']['value'] - 
                yesterday_achievements['destructor']['value']
            )
            
        # –£–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (Nice and Tidy achievement)
        if 'nice_and_tidy' in today_achievements and 'nice_and_tidy' in yesterday_achievements:
            changes['obstacles_removed'] = (
                today_achievements['nice_and_tidy']['value'] - 
                yesterday_achievements['nice_and_tidy']['value']
            )
        
        return changes
```

---

## üìä –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ—Ç—á–µ—Ç–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã –ø–µ—Ä–∏–æ–¥–æ–≤

#### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
```python
class PeriodStatsCalculator:
    def __init__(self, db_connection):
        self.db = db_connection
        
    async def calculate_weekly_stats(self, week_start: date) -> None:
        """–†–∞—Å—á–µ—Ç –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤"""
        
        week_end = week_start + timedelta(days=6)
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
        active_players = await self.db.fetch_all("""
            SELECT DISTINCT player_tag FROM daily_player_changes 
            WHERE change_date BETWEEN ? AND ?
        """, (week_start, week_end))
        
        for player in active_players:
            player_tag = player['player_tag']
            
            # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é  
            weekly_stats = await self.db.fetch_one("""
                SELECT 
                    SUM(trophy_change) as total_trophy_change,
                    SUM(gold_farmed) as total_gold_farmed,
                    SUM(elixir_farmed) as total_elixir_farmed,
                    SUM(dark_elixir_farmed) as total_dark_elixir_farmed,
                    SUM(capital_gold_earned) as total_capital_gold,
                    
                    SUM(attacks_won) as total_attacks_won,
                    SUM(defenses_won) as total_defenses_won,
                    SUM(war_stars_gained) as total_war_stars,
                    SUM(donations_made) as total_donations_made,
                    
                    AVG(trophy_change) as avg_daily_trophies,
                    AVG(donations_made) as avg_daily_donations,
                    
                    COUNT(DISTINCT change_date) as days_active,
                    
                    CASE WHEN COUNT(*) > 0 
                         THEN STDDEV(trophy_change) / (ABS(AVG(trophy_change)) + 1) 
                         ELSE 0 
                    END as consistency_score
                    
                FROM daily_player_changes 
                WHERE player_tag = ? AND change_date BETWEEN ? AND ?
            """, (player_tag, week_start, week_end))
            
            if weekly_stats:
                await self._save_period_stats(player_tag, 'week', week_start, week_end, weekly_stats)
    
    async def calculate_resource_efficiency(self, player_tag: str, period_days: int = 7) -> Dict:
        """–†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ñ–∞—Ä–º–∞ —Ä–µ—Å—É—Ä—Å–æ–≤"""
        
        end_date = date.today()
        start_date = end_date - timedelta(days=period_days)
        
        resource_stats = await self.db.fetch_one("""
            SELECT 
                SUM(gold_farmed) as total_gold,
                SUM(elixir_farmed) as total_elixir,
                SUM(dark_elixir_farmed) as total_dark_elixir,
                SUM(attacks_won) as total_attacks,
                COUNT(DISTINCT change_date) as active_days,
                
                -- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –∞—Ç–∞–∫—É
                CASE WHEN SUM(attacks_won) > 0 
                     THEN SUM(gold_farmed) / SUM(attacks_won) 
                     ELSE 0 
                END as gold_per_attack,
                
                CASE WHEN SUM(attacks_won) > 0 
                     THEN SUM(elixir_farmed) / SUM(attacks_won)
                     ELSE 0 
                END as elixir_per_attack,
                
                CASE WHEN SUM(attacks_won) > 0 
                     THEN SUM(dark_elixir_farmed) / SUM(attacks_won)
                     ELSE 0 
                END as de_per_attack
                
            FROM daily_player_changes 
            WHERE player_tag = ? AND change_date BETWEEN ? AND ?
        """, (player_tag, start_date, end_date))
        
        return {
            'period_days': period_days,
            'active_days': resource_stats['active_days'],
            'total_resources': {
                'gold': resource_stats['total_gold'],
                'elixir': resource_stats['total_elixir'], 
                'dark_elixir': resource_stats['total_dark_elixir']
            },
            'daily_average': {
                'gold': resource_stats['total_gold'] / max(resource_stats['active_days'], 1),
                'elixir': resource_stats['total_elixir'] / max(resource_stats['active_days'], 1),
                'dark_elixir': resource_stats['total_dark_elixir'] / max(resource_stats['active_days'], 1)
            },
            'efficiency_per_attack': {
                'gold': resource_stats['gold_per_attack'],
                'elixir': resource_stats['elixir_per_attack'],
                'dark_elixir': resource_stats['de_per_attack']
            },
            'total_attacks': resource_stats['total_attacks']
        }
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
```python
class AchievementProcessor:
    def __init__(self, db_connection):
        self.db = db_connection
        
    async def process_daily_achievements(self, player_tag: str, changes: Dict) -> List[Dict]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–Ω–µ–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ player_tag
        user_id = await self.db.fetch_val("""
            SELECT user_id FROM user_player_bindings 
            WHERE player_tag = ? AND is_active = TRUE
        """, (player_tag,))
        
        if not user_id:
            return []
            
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        await self._update_activity_stats(user_id, changes)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        new_achievements = await self._check_new_achievements(user_id)
        
        return new_achievements
    
    async def _update_activity_stats(self, user_id: int, changes: Dict) -> None:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        await self.db.execute("""
            INSERT INTO user_activity_stats (user_id, last_activity)
            VALUES (?, CURRENT_DATE)
            ON DUPLICATE KEY UPDATE
                -- –ò–≥—Ä–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
                wars_participated = wars_participated + CASE WHEN ? > 0 THEN 1 ELSE 0 END,
                
                -- –†–µ—Å—É—Ä—Å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è  
                total_gold_farmed = total_gold_farmed + ?,
                total_elixir_farmed = total_elixir_farmed + ?,
                total_dark_elixir_farmed = total_dark_elixir_farmed + ?,
                
                -- –ë–æ–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                buildings_destroyed = buildings_destroyed + ?,
                successful_attacks = successful_attacks + ?,
                successful_defenses = successful_defenses + ?,
                
                -- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                donations_made = donations_made + ?,
                
                -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
                days_active = days_active + 1,
                last_activity = CURRENT_DATE
        """, (
            user_id,
            changes.get('war_stars_gained', 0),  # –£—á–∞—Å—Ç–∏–µ –≤ –≤–æ–π–Ω–µ
            changes.get('gold_farmed', 0),
            changes.get('elixir_farmed', 0), 
            changes.get('dark_elixir_farmed', 0),
            changes.get('buildings_destroyed', 0),
            changes.get('attacks_won', 0),
            changes.get('defenses_won', 0),
            changes.get('donations_made', 0)
        ))
    
    async def _check_new_achievements(self, user_id: int) -> List[Dict]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"""
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = await self.db.fetch_one("""
            SELECT * FROM user_activity_stats WHERE user_id = ?
        """, (user_id,))
        
        if not stats:
            return []
            
        # –ü–æ–ª—É—á–∞–µ–º –Ω–µ–∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        available_achievements = await self.db.fetch_all("""
            SELECT a.* FROM achievements a
            WHERE a.is_active = TRUE 
            AND NOT EXISTS (
                SELECT 1 FROM user_achievements ua 
                WHERE ua.user_id = ? AND ua.achievement_id = a.id
            )
        """, (user_id,))
        
        new_achievements = []
        
        for achievement in available_achievements:
            if await self._check_achievement_criteria(stats, achievement):
                await self._award_achievement(user_id, achievement)
                new_achievements.append(achievement)
                
        return new_achievements
    
    async def _check_achievement_criteria(self, stats: Dict, achievement: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è"""
        
        requirement_type = achievement['requirement_type'] 
        requirement_value = achievement['requirement_value']
        
        criteria_map = {
            # –†–µ—Å—É—Ä—Å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            'gold_farmed': stats.get('total_gold_farmed', 0),
            'elixir_farmed': stats.get('total_elixir_farmed', 0),
            'dark_elixir_farmed': stats.get('total_dark_elixir_farmed', 0),
            
            # –ë–æ–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            'buildings_destroyed': stats.get('buildings_destroyed', 0),
            'attacks_won': stats.get('successful_attacks', 0),
            'defenses_won': stats.get('successful_defenses', 0),
            'wars_participated': stats.get('wars_participated', 0),
            
            # –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è  
            'donations_made': stats.get('donations_made', 0),
            'days_active': stats.get('days_active', 0),
            
            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —á–∞—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é (–∏–∑ –¥—Ä—É–≥–æ–π —Ç–∞–±–ª–∏—Ü—ã)
            'messages_count': await self._get_chat_messages_count(stats['user_id']),
            'help_count': await self._get_help_count(stats['user_id'])
        }
        
        current_value = criteria_map.get(requirement_type, 0)
        return current_value >= requirement_value
```

---

## ‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞ cron –∑–∞–¥–∞—á –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
```python
# Cron –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫
DAILY_TASKS = {
    # –û—Å–Ω–æ–≤–Ω–æ–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC
    "0 2 * * *": "collect_all_player_snapshots",
    
    # –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π - —á–µ—Ä–µ–∑ —á–∞—Å –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞
    "0 3 * * *": "calculate_daily_changes_batch", 
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π - –µ—â–µ —á–µ—Ä–µ–∑ —á–∞—Å
    "0 4 * * *": "process_daily_achievements_batch",
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 05:00
    "0 5 * * *": "cleanup_old_snapshots"
}

WEEKLY_TASKS = {
    # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 06:00
    "0 6 * * 1": "calculate_weekly_stats_all",
    
    # –ú–µ—Å—è—á–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ - –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞ –≤ 07:00  
    "0 7 1 * *": "calculate_monthly_stats_all"
}

class MetricsCronManager:
    def __init__(self, metrics_collector, calculator, achievement_processor):
        self.collector = metrics_collector
        self.calculator = calculator
        self.achievements = achievement_processor
        
    async def collect_all_player_snapshots(self) -> None:
        """–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä –≤—Å–µ—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤"""
        
        start_time = time.time()
        results = await self.collector.collect_daily_snapshots()
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self.logger.info(f"""
        Daily snapshots collection completed:
        - Success: {results['success']} players
        - Failed: {results['failed']} players  
        - Duration: {time.time() - start_time:.2f} seconds
        - Errors: {len(results['errors'])} 
        """)
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
        if results['failed'] > results['success'] * 0.1:  # –ë–æ–ª–µ–µ 10% –æ—à–∏–±–æ–∫
            await self._send_admin_alert(
                "High failure rate in daily snapshots collection", 
                results
            )
    
    async def calculate_daily_changes_batch(self) -> None:
        """Batch —Ä–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –¥–µ–Ω—å"""
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Å–≤–µ–∂–∏–µ —Å–Ω–∞–ø—à–æ—Ç—ã
        players_to_process = await self.db.fetch_all("""
            SELECT DISTINCT player_tag FROM daily_player_snapshots 
            WHERE snapshot_date = CURRENT_DATE 
            AND NOT EXISTS (
                SELECT 1 FROM player_daily_changes 
                WHERE player_tag = daily_player_snapshots.player_tag 
                AND change_date = CURRENT_DATE
            )
        """)
        
        processed = 0
        errors = 0
        
        for player in players_to_process:
            try:
                await self.calculator.calculate_daily_changes(player['player_tag'])
                processed += 1
            except Exception as e:
                self.logger.error(f"Failed to calculate changes for {player['player_tag']}: {e}")
                errors += 1
        
        self.logger.info(f"Daily changes calculated: {processed} success, {errors} errors")
    
    async def process_daily_achievements_batch(self) -> None:
        """Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"""
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        todays_changes = await self.db.fetch_all("""
            SELECT player_tag, * FROM player_daily_changes 
            WHERE change_date = CURRENT_DATE
        """)
        
        total_new_achievements = 0
        
        for change_record in todays_changes:
            try:
                new_achievements = await self.achievements.process_daily_achievements(
                    change_record['player_tag'], 
                    dict(change_record)
                )
                total_new_achievements += len(new_achievements)
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö  
                for achievement in new_achievements:
                    await self._send_achievement_notification(
                        change_record['player_tag'], 
                        achievement
                    )
                    
            except Exception as e:
                self.logger.error(f"Failed to process achievements for {change_record['player_tag']}: {e}")
        
        self.logger.info(f"Processed daily achievements: {total_new_achievements} new achievements earned")
```

---

## üìà –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### `/my_progress [–ø–µ—Ä–∏–æ–¥]` - –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞
```python
async def cmd_my_progress(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –ø–µ—Ä–∏–æ–¥"""
    
    args = message.text.split()[1:] if len(message.text.split()) > 1 else ['week']
    period = args[0] if args[0] in ['day', 'week', 'month'] else 'week'
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    player_tag = await get_user_player_tag(message.from_user.id)
    if not player_tag:
        await message.reply("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç: /create_passport")
        return
        
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    if period == 'day':
        progress_data = await get_daily_progress(player_tag)
    elif period == 'week':
        progress_data = await get_weekly_progress(player_tag) 
    else:
        progress_data = await get_monthly_progress(player_tag)
    
    if not progress_data:
        await message.reply(f"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞ {period}")
        return
        
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    text = f"""
üìä **–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ {PERIOD_NAMES[period]}**
üë§ **{progress_data['player_name']}** ‚úÖ

üèÜ **–ö—É–±–∫–∏:**
‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: {format_change(progress_data['trophy_change'])}
‚Ä¢ –¢–µ–∫—É—â–∏–µ: {progress_data['current_trophies']:,}

üí∞ **–†–µ—Å—É—Ä—Å—ã –Ω–∞—Ñ–∞—Ä–º–ª–µ–Ω–æ:**
‚Ä¢ ü•á –ó–æ–ª–æ—Ç–æ: {format_number(progress_data['gold_farmed'])}
‚Ä¢ ‚öóÔ∏è –≠–ª–∏–∫—Å–∏—Ä: {format_number(progress_data['elixir_farmed'])}
‚Ä¢ üñ§ –¢–µ–º–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä: {format_number(progress_data['dark_elixir_farmed'])}
‚Ä¢ üèõÔ∏è Capital Gold: {format_number(progress_data['capital_gold_earned'])}

‚öîÔ∏è **–ë–æ–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
‚Ä¢ –ê—Ç–∞–∫–∏ –≤—ã–∏–≥—Ä–∞–Ω–æ: {progress_data['attacks_won']}
‚Ä¢ –ó–∞—â–∏—Ç—ã —É—Å–ø–µ—à–Ω–æ: {progress_data['defenses_won']} 
‚Ä¢ –ó–≤–µ–∑–¥—ã –≤ –≤–æ–π–Ω–∞—Ö: +{progress_data['war_stars_gained']}
‚Ä¢ –ó–¥–∞–Ω–∏–π —Ä–∞–∑—Ä—É—à–µ–Ω–æ: {progress_data['buildings_destroyed']}

üéÅ **–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
‚Ä¢ –î–æ–Ω–∞—Ç–æ–≤ —Å–¥–µ–ª–∞–Ω–æ: {progress_data['donations_made']}
‚Ä¢ –î–æ–Ω–∞—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {progress_data['donations_got']}
‚Ä¢ –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: {progress_data['donation_ratio']:.2f}

üìà **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
‚Ä¢ –ó–æ–ª–æ—Ç–∞ –∑–∞ –∞—Ç–∞–∫—É: {progress_data.get('gold_per_attack', 0):,.0f}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π: {progress_data['days_active']}/{period_total_days(period)}
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
    if progress_data.get('achievements_earned'):
        text += f"\nüèÜ **–ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è: {len(progress_data['achievements_earned'])}**\n"
        for ach in progress_data['achievements_earned']:
            text += f"‚Ä¢ {ach['icon']} {ach['title']}\n"
    
    await message.reply(text, parse_mode='Markdown')
```

#### `/my_resources` - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤  
```python
async def cmd_my_resources(message: Message):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º"""
    
    player_tag = await get_user_player_tag(message.from_user.id)
    if not player_tag:
        await message.reply("–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: /create_passport")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
    daily_resources = await get_resource_stats(player_tag, days=1)
    weekly_resources = await get_resource_stats(player_tag, days=7) 
    monthly_resources = await get_resource_stats(player_tag, days=30)
    
    text = f"""
üí∞ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**
üë§ **{daily_resources['player_name']}** ‚úÖ

üìä **–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–∏–æ–¥—ã:**

**üî• –°–µ–≥–æ–¥–Ω—è:**
‚Ä¢ ü•á –ó–æ–ª–æ—Ç–æ: {format_number(daily_resources['total_gold'])}
‚Ä¢ ‚öóÔ∏è –≠–ª–∏–∫—Å–∏—Ä: {format_number(daily_resources['total_elixir'])}  
‚Ä¢ üñ§ –¢–µ–º–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä: {format_number(daily_resources['total_dark_elixir'])}
‚Ä¢ –ê—Ç–∞–∫: {daily_resources['total_attacks']}

**üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é:**
‚Ä¢ ü•á –ó–æ–ª–æ—Ç–æ: {format_number(weekly_resources['total_gold'])} (—Å—Ä–µ–¥–Ω–µ–µ: {format_number(weekly_resources['total_gold']/7)}/–¥–µ–Ω—å)
‚Ä¢ ‚öóÔ∏è –≠–ª–∏–∫—Å–∏—Ä: {format_number(weekly_resources['total_elixir'])} (—Å—Ä–µ–¥–Ω–µ–µ: {format_number(weekly_resources['total_elixir']/7)}/–¥–µ–Ω—å)
‚Ä¢ üñ§ –¢–µ–º–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä: {format_number(weekly_resources['total_dark_elixir'])} (—Å—Ä–µ–¥–Ω–µ–µ: {format_number(weekly_resources['total_dark_elixir']/7)}/–¥–µ–Ω—å)  
‚Ä¢ –ê—Ç–∞–∫: {weekly_resources['total_attacks']} (—Å—Ä–µ–¥–Ω–µ–µ: {weekly_resources['total_attacks']/7:.1f}/–¥–µ–Ω—å)

**üìÖ –ó–∞ –º–µ—Å—è—Ü:**
‚Ä¢ ü•á –ó–æ–ª–æ—Ç–æ: {format_number(monthly_resources['total_gold'])}
‚Ä¢ ‚öóÔ∏è –≠–ª–∏–∫—Å–∏—Ä: {format_number(monthly_resources['total_elixir'])}
‚Ä¢ üñ§ –¢–µ–º–Ω—ã–π —ç–ª–∏–∫—Å–∏—Ä: {format_number(monthly_resources['total_dark_elixir'])}
‚Ä¢ –ê—Ç–∞–∫: {monthly_resources['total_attacks']}

‚ö° **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:**
‚Ä¢ –ó–æ–ª–æ—Ç–∞ –∑–∞ –∞—Ç–∞–∫—É: {weekly_resources['efficiency']['gold_per_attack']:,.0f}
‚Ä¢ –≠–ª–∏–∫—Å–∏—Ä–∞ –∑–∞ –∞—Ç–∞–∫—É: {weekly_resources['efficiency']['elixir_per_attack']:,.0f}
‚Ä¢ –¢–≠ –∑–∞ –∞—Ç–∞–∫—É: {weekly_resources['efficiency']['de_per_attack']:,.0f}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π: {weekly_resources['active_days']}/7

üéØ **–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:**
‚Ä¢ Gold Grab: {format_achievement_progress('gold_grab', player_tag)}
‚Ä¢ Elixir Escapade: {format_achievement_progress('elixir_escapade', player_tag)}
‚Ä¢ Heroic Heist: {format_achievement_progress('heroic_heist', player_tag)}
"""

    await message.reply(text, parse_mode='Markdown')
```

---

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### Performance –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### Batch processing –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
class OptimizedMetricsCollector:
    def __init__(self, coc_api, db_connection, redis_client):
        self.coc_api = coc_api
        self.db = db_connection
        self.redis = redis_client
        
    async def collect_batch_optimized(self, player_tags: List[str]) -> Dict:
        """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π batch —Å–±–æ—Ä —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –¥–ª—è –Ω–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤  
        cached_results = await self._check_cached_data(player_tags)
        
        # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫–æ–≥–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
        players_to_fetch = [
            tag for tag in player_tags 
            if tag not in cached_results
        ]
        
        results = cached_results.copy()
        
        if players_to_fetch:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º connection pooling –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
            async with aiohttp.ClientSession(
                connector=aiohttp.TCPConnector(limit=20),
                timeout=aiohttp.ClientTimeout(total=30)
            ) as session:
                
                # Batch –∑–∞–ø—Ä–æ—Å—ã —Å rate limiting
                batch_results = await self._fetch_players_batch(
                    session, players_to_fetch
                )
                results.update(batch_results)
                
                # –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                await self._cache_results(batch_results)
        
        return results
    
    async def _check_cached_data(self, player_tags: List[str]) -> Dict:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        
        cached = {}
        
        # Batch –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ Redis
        cache_keys = [f"player_snapshot:{tag}" for tag in player_tags]
        cached_values = await self.redis.mget(cache_keys)
        
        for i, value in enumerate(cached_values):
            if value:
                player_tag = player_tags[i]
                cached_data = json.loads(value)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –¥–∞–Ω–Ω—ã—Ö (–º–∞–∫—Å–∏–º—É–º 23 —á–∞—Å–∞)
                if self._is_cache_valid(cached_data['timestamp']):
                    cached[player_tag] = cached_data['snapshot']
                    
        return cached
    
    async def _fetch_players_batch(self, session: aiohttp.ClientSession, 
                                 player_tags: List[str]) -> Dict:
        """Batch –∑–∞–ø—Ä–æ—Å—ã –∫ API —Å rate limiting"""
        
        results = {}
        
        # Rate limiting: –º–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
        semaphore = asyncio.Semaphore(10)
        
        async def fetch_single_player(tag: str):
            async with semaphore:
                try:
                    player_data = await self.coc_api.get_player(tag, session=session)
                    if player_data:
                        results[tag] = self._extract_snapshot_data(player_data)
                    await asyncio.sleep(0.1)  # Rate limiting
                except Exception as e:
                    self.logger.error(f"Failed to fetch {tag}: {e}")
                    
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
        await asyncio.gather(
            *[fetch_single_player(tag) for tag in player_tags],
            return_exceptions=True
        )
        
        return results
```

#### Database –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE daily_player_snapshots_2025_10 
PARTITION OF daily_player_snapshots
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

CREATE TABLE daily_player_snapshots_2025_11 
PARTITION OF daily_player_snapshots  
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX CONCURRENTLY idx_snapshots_player_recent 
ON daily_player_snapshots (player_tag, snapshot_date DESC) 
WHERE snapshot_date >= CURRENT_DATE - INTERVAL '30 days';

CREATE INDEX CONCURRENTLY idx_changes_trophy_range
ON player_daily_changes (change_date, trophy_change)
WHERE trophy_change != 0;

-- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
CREATE MATERIALIZED VIEW player_monthly_aggregates AS
SELECT 
    player_tag,
    DATE_TRUNC('month', change_date) as month,
    SUM(trophy_change) as monthly_trophy_change,
    SUM(gold_farmed) as monthly_gold,
    SUM(elixir_farmed) as monthly_elixir,
    SUM(dark_elixir_farmed) as monthly_dark_elixir,
    COUNT(*) as active_days
FROM player_daily_changes
GROUP BY player_tag, DATE_TRUNC('month', change_date);

-- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
CREATE OR REPLACE FUNCTION refresh_monthly_aggregates()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY player_monthly_aggregates;
END;
$$ LANGUAGE plpgsql;

-- Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
SELECT cron.schedule('refresh-aggregates', '0 1 * * *', 'SELECT refresh_monthly_aggregates();');
```

---

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVP –ø–∞—Å–ø–æ—Ä—Ç–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è MVP:**
1. ‚úÖ **–ë–∞–∑–æ–≤—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã** - –∫—É–±–∫–∏, —É—Ä–æ–≤–µ–Ω—å, –¥–æ–Ω–∞—Ç—ã
2. ‚úÖ **–ü—Ä–æ—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫—É–±–∫–æ–≤, –¥–æ–Ω–∞—Ç–æ–≤ –∑–∞ –¥–µ–Ω—å
3. ‚úÖ **–†–µ—Å—É—Ä—Å–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Gold Grab, Elixir Escapade
4. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

**–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å:**
- üîÑ –°–ª–æ–∂–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- üîÑ –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è  
- üîÑ –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π CoC
- üîÑ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã

### –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —Å—Ç–∞–¥–∏–∏ MVP

```sql
-- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è MVP
CREATE TABLE player_daily_snapshots_mvp (
    player_tag VARCHAR(15) NOT NULL,
    snapshot_date DATE NOT NULL,
    
    -- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    trophies INTEGER NOT NULL,
    donations_given INTEGER DEFAULT 0,
    donations_received INTEGER DEFAULT 0,
    war_stars INTEGER DEFAULT 0,
    
    -- –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (JSON)
    key_achievements JSON DEFAULT '{}', -- –¢–æ–ª—å–∫–æ Gold Grab, Elixir Escapade, Heroic Heist
    
    PRIMARY KEY (player_tag, snapshot_date),
    INDEX idx_recent (snapshot_date DESC)
);

-- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
CREATE TABLE player_daily_changes_mvp (
    player_tag VARCHAR(15) NOT NULL,
    change_date DATE NOT NULL,
    
    trophy_change INTEGER DEFAULT 0,
    donations_change INTEGER DEFAULT 0,
    war_stars_change INTEGER DEFAULT 0,
    
    -- –†–µ—Å—É—Ä—Å—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ)
    gold_farmed BIGINT DEFAULT 0,
    elixir_farmed BIGINT DEFAULT 0,
    dark_elixir_farmed INTEGER DEFAULT 0,
    
    PRIMARY KEY (player_tag, change_date)
);
```

–°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ —Å—Ç–∞–Ω–µ—Ç –º–æ—â–Ω—ã–º —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–æ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, —Å–æ–∑–¥–∞–≤–∞—è –∑–∞–º–∫–Ω—É—Ç—ã–π —Ü–∏–∫–ª –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ –ø–∞—Å–ø–æ—Ä—Ç–æ–≤! üöÄ